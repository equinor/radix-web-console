import { List, Tooltip, Typography } from '@equinor/eds-core-react';
import * as PropTypes from 'prop-types';

import { ScanModel, ScanModelValidationMap } from '../../models/scan';
import { ScanStatus } from '../../models/scan-status';
import {
  VulnerabilitySummaryModel,
  VulnerabilitySummaryModelValidationMap,
} from '../../models/vulnerability-summary';

import './style.css';

export interface VulnerabilitySummaryProps {
  vulnerabilitySummary: VulnerabilitySummaryModel;
}

const VulnerabilityItem = ({
  severity,
  count,
}: {
  severity: keyof typeof VulnerabilitySummaryModelValidationMap;
  count: number;
}): JSX.Element => (
  <List.Item
    key={severity}
    className={`severity-summary__item severity-summary__item--${
      (count && severity) || 'none'
    }`}
  >
    <div className="severity-summary__count">
      <span className="severity-summary__label">{count || 0}</span>
    </div>
    <Tooltip placement="top" title={`${severity} issues`}>
      <div className="severity-summary__text">
        <span className="severity-summary__label">
          {severity[0].toUpperCase()}
        </span>
      </div>
    </Tooltip>
  </List.Item>
);

export const VulnerabilitySummary = (
  props: VulnerabilitySummaryProps
): JSX.Element => {
  const keys = Object.keys(VulnerabilitySummaryModelValidationMap) as Array<
    keyof typeof VulnerabilitySummaryModelValidationMap
  >;

  return (
    <List className="severity-summary">
      {keys
        .filter((key) => key !== 'unknown')
        .sort((x, y) => keys.indexOf(x) - keys.indexOf(y))
        .map((key) => (
          <VulnerabilityItem
            key={key}
            severity={
              key as keyof typeof VulnerabilitySummaryModelValidationMap
            }
            count={props.vulnerabilitySummary[key]}
          />
        ))}
      {props.vulnerabilitySummary.unknown && (
        <VulnerabilityItem
          severity={'unknown'}
          count={props.vulnerabilitySummary.unknown}
        />
      )}
    </List>
  );
};

export const VulnerabilitySummaryTotal = ({
  scans,
}: {
  scans: ScanModel[];
}): JSX.Element => {
  const summary = scans?.reduce<{
    errors: number;
    vulnerabilities: VulnerabilitySummaryModel;
  }>(
    (result, scan) => {
      result.errors += scan.status !== ScanStatus.Success ? 1 : 0;

      Object.keys(scan.vulnerabilities).forEach((key) => {
        if (scan.vulnerabilities[key]) {
          result.vulnerabilities[key] = result.vulnerabilities[key]
            ? result.vulnerabilities[key] + scan.vulnerabilities[key]
            : scan.vulnerabilities[key];
        }
      });
      return result;
    },
    { errors: 0, vulnerabilities: {} }
  );

  return summary ? (
    <>
      <VulnerabilitySummary vulnerabilitySummary={summary.vulnerabilities} />
      {summary.errors > 0 && (
        <Typography color="warning">
          {summary.errors} of {scans.length} vulnerability scans has an error
        </Typography>
      )}
    </>
  ) : null;
};

VulnerabilitySummary.propTypes = {
  vulnerabilitySummary: PropTypes.shape(VulnerabilitySummaryModelValidationMap)
    .isRequired,
};

VulnerabilitySummaryTotal.propTypes = {
  scans: PropTypes.arrayOf(PropTypes.shape(ScanModelValidationMap)).isRequired,
};
