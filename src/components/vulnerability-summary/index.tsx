import { List, Tooltip, Typography } from '@equinor/eds-core-react';
import { clsx } from 'clsx';
import * as PropTypes from 'prop-types';

import { ScanModel, ScanModelValidationMap } from '../../models/scan';
import {
  VulnerabilitySummaryModel,
  VulnerabilitySummaryModelValidationMap,
} from '../../models/scan-api/models/vulnerability-summary';
import { ScanStatus } from '../../models/scan-status';

import './style.css';

export interface VulnerabilitySummaryProps {
  summary?: VulnerabilitySummaryModel;
  visibleKeys?: Array<keyof VulnerabilitySummaryModel>;
}

export interface VulnerabilitySummaryTotalProps {
  scans: Array<ScanModel>;
}

const VulnerabilityBadge = ({
  severity,
  count,
}: {
  severity: keyof VulnerabilitySummaryModel;
  count: number;
}): JSX.Element => (
  <div
    className={clsx('severity-summary-badge', {
      [`severity-summary-badge__${severity}`]: !!(count && severity),
    })}
  >
    <Typography className="severity-summary-badge__count">
      {count ?? 0}
    </Typography>
    <Tooltip placement="top" title={`${severity} issues`}>
      <Typography className="severity-summary-badge__text">
        {severity[0].toUpperCase()}
      </Typography>
    </Tooltip>
  </div>
);

export const VulnerabilitySummary = ({
  summary,
  visibleKeys,
}: VulnerabilitySummaryProps): JSX.Element => {
  const keys =
    visibleKeys?.length > 0
      ? visibleKeys
      : (Object.keys(VulnerabilitySummaryModelValidationMap) as Array<
          keyof typeof VulnerabilitySummaryModelValidationMap
        >);

  return (
    <List className="grid grid--gap-small grid--auto-columns">
      {keys
        .filter((key) => !(key === 'unknown' && !summary?.[key]))
        .sort((x, y) => keys.indexOf(x) - keys.indexOf(y))
        .map((key) => (
          <List.Item key={key}>
            <VulnerabilityBadge severity={key} count={summary?.[key] ?? 0} />
          </List.Item>
        ))}
    </List>
  );
};

export const VulnerabilitySummaryTotal = ({
  scans,
}: VulnerabilitySummaryTotalProps): JSX.Element => {
  const summary = scans.reduce<{
    errors: number;
    vulnerabilities: VulnerabilitySummaryModel;
  }>(
    (result, scan) => {
      result.errors += +(scan.status !== ScanStatus.Success);

      Object.keys(scan.vulnerabilities || {}).forEach((key) => {
        if (scan.vulnerabilities[key]) {
          result.vulnerabilities[key] =
            (result.vulnerabilities[key] || 0) + scan.vulnerabilities[key];
        }
      });
      return result;
    },
    { errors: 0, vulnerabilities: {} }
  );

  return (
    <>
      <VulnerabilitySummary summary={summary.vulnerabilities} />
      {summary.errors > 0 && (
        <Typography color="warning">
          {summary.errors} of {scans.length} vulnerability scans has an error
        </Typography>
      )}
    </>
  );
};

VulnerabilitySummary.propTypes = {
  summary: PropTypes.shape(VulnerabilitySummaryModelValidationMap),
} as PropTypes.ValidationMap<VulnerabilitySummaryProps>;

VulnerabilitySummaryTotal.propTypes = {
  scans: PropTypes.arrayOf(PropTypes.shape(ScanModelValidationMap)).isRequired,
} as PropTypes.ValidationMap<VulnerabilitySummaryTotalProps>;
